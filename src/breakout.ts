// https://www.typescriptlang.org/play?removeComments=true&target=7&jsx=0&module=6#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-vU9+5vDdzr-7zcqqNWxWPkAfdp7TxhgNXZg9utDx68PRt9dDCp8ovVtPQAkYd8JwXR3NXm-LTeI7Ax+dAYjZhrsPM6+vZvJSMUSjnNhTnOgG36Ge-Vp6pb4KNN4Bq6zJriP5v3sx5oE4eA3YCK853oLpgjzbYy-H7mMsPAg3m8x3q2Zu5QAAH48wAUgHM7k7JDe7iu7m7Iokrkg3hCg2zmD55E5kCQA3iXgVhVh2A0AvKQQLAH7UCoGDD3677aqjqgHgFoCQHQHd54G443gmjx7OI4CL6gBy7tpLrsyW7W564T557R6F7x6+iJ5lSDh8LZ5sHu754H4rjNTdAMhHYhCtiQACGR4e4UH56oS4AMRlS9KGrUCyG55CEcFISQBQHGpCTgAhCSBOCgDyAABqGQyMpUZeJ4PMleZGPMuBIa2hBe7uRWE2EhoAUhIYMhQBzqrhMeuh+hkEQkSaokx40A+AZAQo7Akklet69hE+jh0QcwE60EBs7ci6Uoy6U+YGs+hUj0Ts8U70TmzSLAq4tA4YGAXAwuXUYewS5IfYosaOBuy+yEfeK2O6veXMBUD8rBOe2qvekoXebmIMXYXksABAgm7RcBIxSOE+veox3RK+vRWAD8H8wSdubRQxK+R2pEthQMA+sxPUXo6xeOu89OJxIxbgfQ7mJ4kx0xKxHR8xDmzxcByx5ut6OG7xpxfRBAH87cpRTCzSQMc2JoUMdREyU8D+WYzRl09uuxHR-oimvxax-RlxS+SJcx2mYxDxoYTx1xvoCxvxuJaJZxGxKOWxSWOxeqve-oBx5uZGPxJx6JFxJRCUpJj+2qKRbxJxnxgeI+Y+beZBQifQfQwWtJz0uOK20EE+jaQaCOgJ26e+8Keq4mR+J+gwTASi0UWA0UWSFxO8HJWkdQi60AbWMoY628cUYM9e2pYG4BBADAG8SwhpqUDI9seU+piwDm9pjej0L+Go9CwEdOL2-2cAgEb+swoES4ZAgw9xExGAMA86iZpxaY0APATsqwX0cp8wAAnJoAsQKN1vKdGRoGmcmUWLbGmVzBmVmbZh4J9HmaAPmZ9A5vQatC6IWDgICggOru2l2JhOFBQC6pAIIGDMljqZ7u7vAEKAQFYNAJ0jMdiZ0fMOSf8ZXvSUsFlosSvjcaRHKSaZydcaMXceMY8SuXSfuaqsWXuR0aMdOZ0ccauWyX6QwRaeONMQsajl1tsQ6UorVLOfOYucub8f3veXAWyVuSvsSXVpBTeDcYpkeXaQhTcRWReQSVebujeXeeBW4E+UdvME+d8euayRSQCaheaZafNLQatJ2QlFOY6SqnOX4KBfGeBTBciWkRuecTudlr8ZKAyangMSeauUJbcWmVhYJcSe+VyRoE+f6C+deR0W+VRdQJ+VaXRQlL+atKWQfABTOWQKxQuUuRxfyVxXAUpQhWyfxWhSiSJZiVceJbiVJVMdhcMbJahfJf9IBf6MRY6cyWRa+RRe+dRV+dpcjvRXTo6IcnIsgOnBQHNvAG5FgDwJ6dyNOamowJ8kIIlaBkWv9r8vLpauhanm2hJRoMCF-CIDOnOrbJdMOlagSretrogXDo1QruyoqpymRm1deIxk1aqv1VWINV1c1f6L6CNR1atE1T1dalon5gFtQdFJ1ZavNQSoVC6RFO-rsssqqKwTupfpSNfpkb2t6lfsUQiYfM-P4v9OfJfJ1LfOwQXroVwTwW7n5k9S-C9UEchD7jupDhPtDhPkHskdXvarLlkeNZcuGKLpzhLkKpBIwOyPDYqCzuHk5UEqMYLuvKxA+DhkrDqmGjJD3HQBwGmPOAlVgKxD7ugdUeRqDSPkRv4XqqMWmTwEKAmReS8qqinredFETd8RRgiOCPhn8FDedYCixSBWZZBMNaAPfgNaAFNYrTrtQKwc7pfBDtVqQWzfBUdvJnrWuUzeXvBQycbf6LuSiZbTxUyRDRksjnFasAlfVJUTZEwg-CaA-numwkDJRKQFwNKDAIIKKL6Lld8kekgPFE1WVe4MSO2VLeypVR4AnVOrVbOiaA1RpnNT6pymydNatTneNQrUraNa3sXZaqrWXXDhXXvLncCgtbDstfOIxodebsdcFBkaqPQbnZdRvlvhrlrmre1awRTifPdS7iqdqkRRoAPerprm+l4D0CsBPiMazTeP5XPargvaoGAMvb0KsDukJd9XwEBVHmxJWL2WgFYOMdpc9YEUGIINhUDTuiDUdRRX7tFGmVYIYKvQ+seAjpxg-RfX9T-gng3J9dFqfbjYEYXrQbFUAA
// Global Config Constants for Breakout Game
const NUM_ROWS = 8;
const BRICK_TOP_OFFSET = 10;
const BRICK_SPACING = 2;
const NUM_BRICKS_PER_ROW = 10;
const BRICK_HEIGHT = 10;
const SPACE_FOR_BRICKS = 400 - (NUM_BRICKS_PER_ROW + 1) * BRICK_SPACING;
const BRICK_WIDTH = SPACE_FOR_BRICKS / NUM_BRICKS_PER_ROW;
const PADDLE_WIDTH = 60;
const PADDLE_HEIGHT = 10;
const PADDLE_OFFSET = 10;
const BALL_RADIUS = 7;
const defaultOptions: IGame = {
  infiniteLives: false,
  keepScore: false,
  auto: false,
  low: false,
};

// Global readonly variables
let game: Game | undefined;
let gameLoop: NodeJS.Timer | undefined;

// variable unchanged when game restarts
// Using BigInt for larger score storage than `Number.MAX_SAFE_INTEGER`
let globalScore = BigInt(0);

/** Will Always Run */
(() => {
  const startBtn = document.getElementById("start-game") as HTMLButtonElement;
  const reset = document.getElementById("reset") as HTMLButtonElement;
  startBtn.addEventListener("click", () => {
    startBtn.setAttribute("disabled", "");
    startBtn.className = "disabled";
    reset.removeAttribute("disabled");
    reset.className = "";

    game = new Game({ ...defaultOptions });
    if (defaultOptions.low)
      // 15hz refresh rate
      gameLoop = setInterval(() => game.update(66.666666666667), 66.666666666667);
    // 45hz refresh rate = 1 frame/22.2222222222ms
    else gameLoop = setInterval(() => game.update(22.2222222222), 22.2222222222);
  });

  reset.addEventListener("click", () => {
    clearInterval(gameLoop);
    game = undefined;

    startBtn.removeAttribute("disabled");
    startBtn.className = "";
    reset.setAttribute("disabled", "");
    reset.className = "disabled";
  });

  (document.getElementById("pause") as HTMLButtonElement).addEventListener("click", () => {
    if (!game) return;
    game.pause = !game.pause;
  });

  createSwitchListener("auto_mode", "auto");
  createSwitchListener("potato_mode", "low");
  createSwitchListener("keep_score", "keepScore");
  createSwitchListener("infinite_lives", "infiniteLives");
})();

/** Function to create and configure switches */
function createSwitchListener(id: string, option: keyof IGame) {
  const elem = document.getElementById(id) as HTMLInputElement;
  elem.addEventListener("click", () => (defaultOptions[option] = elem.checked));
}

interface IGame {
  infiniteLives: boolean;
  keepScore: boolean;
  auto: boolean;
  low: boolean;
}

/** Game class to handle element and render management */
class Game {
  public readonly scoreboard = document.getElementById("score");
  public readonly livesboard = document.getElementById("lives");
  public readonly canvas = document.getElementById("game") as HTMLCanvasElement;
  public readonly context = this.canvas.getContext("2d")!;
  public readonly height = this.canvas.height;
  public readonly width = this.canvas.width;

  public elements: Rectangle[] = [];
  public paddle: Rectangle;
  public ball: Ball;

  private stop = false;
  public pause = false;
  public score = 0;
  public lives = 3;

  constructor(private readonly options: IGame) {
    this.ball = new Ball(BALL_RADIUS, this.width / 2, this.height / 2, "#bbbbbb");
    this.paddle = new Rectangle(
      PADDLE_WIDTH,
      PADDLE_HEIGHT,
      this.width / 2 - PADDLE_WIDTH / 2,
      this.height - PADDLE_OFFSET - PADDLE_HEIGHT,
      "#bbbbbb"
    );
    this.elements.push(this.paddle);

    for (let i = 0; i < 8; i++) {
      const y = BRICK_TOP_OFFSET + (BRICK_HEIGHT + BRICK_SPACING) * i;
      // Colour Management
      let colour: string;
      if (i < 2) colour = "red";
      else if (i > 1 && i < 4) colour = "orange";
      else if (i > 3 && i < 6) colour = "green";
      else colour = "rgb(77, 77, 255)";

      for (let e = 0; e < NUM_BRICKS_PER_ROW; e++) {
        const x = BRICK_SPACING * (e + 1) + BRICK_WIDTH * e;
        this.elements.push(new Rectangle(BRICK_WIDTH, BRICK_HEIGHT, x, y, colour, true));
      }
    }
    if (this.options.infiniteLives) this.lives = Infinity;
    if (!this.options.auto) this.canvas.addEventListener("mousemove", (e) => this.paddle.handleMouseMovement(e));
  }

  public update(elapsedMS: number) {
    if (this.stop) return this.endGame();
    else if (this.pause) return;
    this.context.clearRect(0, 0, this.width, this.height);
    this.context.fillStyle = "rgba(0, 0, 0, 0.1)";
    this.context.fillRect(0, 0, this.width, this.height);

    if (this.options.auto) this.paddle.x = this.ball.x - this.paddle.width / 2;

    this.detectCollision();
    this.ball.render(elapsedMS);
    this.elements.forEach((e) => e.render());

    const num = this.options.keepScore ? globalScore : this.score;
    this.scoreboard.innerText = Intl.NumberFormat().format(num);
    this.livesboard.innerText = this.lives.toString();
  }

  private endGame() {
    this.context.fillStyle = "white";
    this.context.font = "40px Arial";
    this.context.textAlign = "center";
    this.context.fillText("GAME OVER!", this.width / 2, this.height / 2);
    this.context.font = "25px Arial";
    this.context.fillText("Restart to Continue", this.width / 2, this.height / 2 + 30);
  }

  private detectCollision() {
    // Check for left and right edges
    if (this.ball.x < this.ball.radius) {
      this.ball.vx = Math.abs(this.ball.vx);
      this.ball.x = this.ball.radius;
    } else if (this.ball.x > this.width - this.ball.radius) {
      this.ball.vx = -Math.abs(this.ball.vx);
      this.ball.x = this.width - this.ball.radius;
    }

    // chech for top and bottom edges
    if (this.ball.y < this.ball.radius) {
      this.ball.vy = Math.abs(this.ball.vy);
      this.ball.y = this.ball.radius;
    } else if (this.ball.y > this.height - this.ball.radius) {
      this.ball.y = this.height / 2;
      this.ball.x = this.width / 2;
      this.lives--;
      if (this.lives < 0) this.stop = true;
    }

    this.elements.forEach((rect, i, elems) => {
      const progress = () => {
        if (rect.isBrick) elems.splice(i, 1);
        if (this.options.keepScore) globalScore += BigInt(Math.floor(Math.random() * 150) + 98);
        else this.score += Math.floor(Math.random() * 150) + 95;
      };

      // Logic based physics calc
      if (rect.containsPoint(this.ball.x + this.ball.radius, this.ball.y) && this.ball.vx > 0) {
        this.ball.vx = -Math.abs(this.ball.vx);
        this.ball.x = rect.x - this.ball.radius;
        progress();
      } else if (rect.containsPoint(this.ball.x - this.ball.radius, this.ball.y) && this.ball.vx < 0) {
        this.ball.vx = Math.abs(this.ball.vx);
        this.ball.x = rect.x + rect.width + this.ball.radius;
        progress();
      }

      if (rect.containsPoint(this.ball.x, this.ball.y + this.ball.radius) && this.ball.vy > 0) {
        this.ball.vy = -Math.abs(this.ball.vy);
        this.ball.y = rect.y - this.ball.radius;
        progress();
      } else if (rect.containsPoint(this.ball.x, this.ball.y - this.ball.radius) && this.ball.vy < 0) {
        this.ball.vy = Math.abs(this.ball.vy);
        this.ball.y = rect.y + rect.height + this.ball.radius;
        progress();
      }
    });
  }
}

/** Class for a simple rectangle*/
class Rectangle {
  public vx = 0;
  public vy = 0;

  constructor(
    public readonly width: number,
    public readonly height: number,
    public x: number,
    public readonly y: number,
    public readonly colour: string,
    public readonly isBrick?: boolean
  ) {
    this.render();
  }

  public render() {
    if (!game) return;
    game.context.fillStyle = this.colour;
    game.context.fillRect(this.x, this.y, this.width, this.height);
  }

  public handleMouseMovement(e: MouseEvent) {
    const x = e.clientX - game.canvas.getBoundingClientRect().left - this.width / 2;
    this.x = Math.min(Math.max(0, x), game.width - PADDLE_WIDTH);
  }

  public containsPoint(x: number, y: number) {
    return x >= this.x && x <= this.x + this.width && y >= this.y && y <= this.y + this.height;
  }
}

/** Class for a custom ball with constant velocity*/
class Ball {
  public vx = 175;
  public vy = 175;

  constructor(public readonly radius: number, public x: number, public y: number, public readonly colour: string) {
    this.render(0);
  }

  public render(elapsedMS: number) {
    if (!game) return;
    this.x += (elapsedMS / 1000) * this.vx;
    this.y += (elapsedMS / 1000) * this.vy;
    game.context.beginPath();
    game.context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
    game.context.fillStyle = this.colour;
    game.context.fill();
  }
}
